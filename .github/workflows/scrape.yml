name: Scrape

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  scrape:
    strategy:
      fail-fast: false
      matrix:
        state:
          [
            AL,
            AK,
            AZ,
            AR,
            CA,
            CO,
            CT,
            DE,
            FL,
            GA,
            HI,
            ID,
            IL,
            IN,
            IA,
            KS,
            KY,
            LA,
            ME,
            MD,
            MA,
            MI,
            MN,
            MS,
            MO,
            MT,
            NE,
            NV,
            NH,
            NJ,
            NM,
            NY,
            NC,
            ND,
            OH,
            OK,
            OR,
            PA,
            RI,
            SC,
            SD,
            TN,
            TX,
            UT,
            VT,
            VA,
            WA,
            WV,
            WI,
            WY,
          ]

    runs-on: ubuntu-latest

    steps:
      - name: Checkout data
        uses: actions/checkout@v2
        with:
          ref: ${{ matrix.state }}
          path: data
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.9"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install warn-scraper
      - name: Run scrapers
        env:
          STATE: ${{ matrix.state }}
        run: |-
          mkdir -p data/files || true
          mkdir -p data/logs || true
          mkdir -p /home/runner/.warn-scraper/exports/ || true
          rm "data/logs/"${{ env.STATE }}".log" || true
          warn-scraper ${{ env.STATE }} --cache-dir data/files --log-level DEBUG
          cp /home/runner/.warn-scraper/exports/* data/ || true
          ! cp /home/runner/.warn-scraper/logs/* data/logs/
      - name: Commit and push
        env:
          STATE: ${{ matrix.state }}
        run: |-
          cd ./data
          git config user.name "WARN scraper bot"
          git config user.email "actions@users.noreply.github.com"
          git add -A
          timestamp=$(date -u)
          git commit -m "${{ env.STATE }} - ${timestamp}" || exit 0
          git push
